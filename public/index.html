<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="theme-color" content="black">
    <meta name="viewport" content="user-scalable=yes, initial-scale=1.0, maximum-scale=10.0, width=device-width" />
    <title>Scribbles</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdn.rawgit.com/tklepzig/flex-layout/master/dist/flex-layout.min.css">
    <style>
    html {
        min-height: 100%;
        height: 100%;
    }
    body {
        background: #1d1d1d;
        color: #ededed;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    textarea {
        padding: 12px;
        font-size: 12pt;
        background: inherit;
        border: none;
        outline: none;
        resize: none;
        font-family: inherit;
        color: inherit;
        transition: opacity 0.8s ease-in-out;
        opacity: 0;
    }
    textarea.ready {
        opacity: 1;
    }
    </style>
</head>

<body class="layout-v layout-fill">
    <textarea autofocus class="flex"></textarea>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var path = window.location.pathname;
        var pathArray = path.split('/');
        var id = pathArray.pop();
        if (id.length === 0) {
            id = pathArray.pop();
        }

        function getFirstLine(text) {
            var indexOfFirstLineBreak = text.indexOf('\n');
            if (indexOfFirstLineBreak === -1) {
                return text;
            }
            return text.substring(0, indexOfFirstLineBreak);
        }

        function setWindowTitle(title) {
            if (title.length > 0) {
                document.title = title + " - Scribbles";
            }
            else {
                document.title = "Scribbles";
            }
        }

        socket.emit('load', id, function (text) {
            $('textarea').val(text);
            $('textarea').addClass('ready');
            setWindowTitle(getFirstLine(text));
        });

        $('textarea').on('input', function () {
            socket.emit('change', { id: id, text: $('textarea').val() });
            setWindowTitle(getFirstLine($('textarea').val()));
        });

        socket.on('change', function (e) {
            if (e.id === id) {
                $('textarea').val(e.text);
                setWindowTitle(getFirstLine(e.text));
            }
        });
    </script>
</body>

</html>